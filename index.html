<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bus Tracker - Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #21D375;
            --primary-dark: #1BB863;
            --secondary: #FFC632;
            --dark: #1A1D29;
            --darker: #12141C;
            --light: #F8F9FA;
            --gray: #8E8E93;
            --gray-dark: #636366;
            --card-bg: #252836;
            --danger: #FF3B30;
            --warning: #FF9500;
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--darker);
            color: var(--light);
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        header {
            background-color: var(--dark);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            background-color: var(--primary);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .header-icon {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 66px);
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: var(--dark);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-connected {
            background-color: var(--primary);
        }
        
        .status-disconnected {
            background-color: var(--danger);
        }
        
        .status-tracking {
            background-color: var(--warning);
        }
        
        .status-idle {
            background-color: var(--gray);
        }
        
        .map-container {
            flex: 1;
            position: relative;
            min-height: 300px;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .bottom-panel {
            background-color: var(--dark);
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 500;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .panel-toggle {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1rem;
            cursor: pointer;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .card-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--light);
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:active {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--light);
        }
        
        .btn-secondary:active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tracking-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tracking-btn {
            flex: 1;
            padding: 18px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .log-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .log-panel.expanded {
            max-height: 200px;
        }
        
        .log-header {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .log-entries {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }
        
        .log-time {
            color: var(--primary);
            font-size: 0.7rem;
            margin-right: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--dark);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .bus-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--dark);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            z-index: 400;
            box-shadow: var(--shadow);
            max-width: 200px;
        }
        
        .bus-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .bus-info-label {
            color: var(--gray);
        }
        
        .bus-info-value {
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .tracking-controls {
                flex-direction: column;
            }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-pulse {
            animation: pulse 2s infinite;
        }
        
        .preconfigured-badge {
            background-color: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            margin-left: 8px;
        }
        
        .connection-test {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        .test-btn {
            background: var(--secondary);
            color: var(--dark);
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
            margin-right: 5px;
        }
        
        .debug-btn {
            background: var(--warning);
            color: var(--dark);
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-bus"></i>
            </div>
            <div class="logo-text">School Bus Tracker</div>
        </div>
        <div class="header-actions">
            <button class="header-icon" id="settings-btn">
                <i class="fas fa-cog"></i>
            </button>
            <button class="header-icon" id="help-btn">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    </header>
    
    <div class="container">
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-disconnected" id="connection-indicator"></div>
                <span id="connection-status">Disconnected</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-idle" id="tracking-indicator"></div>
                <span id="tracking-status">Not Tracking</span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="bus-info">
                <div class="bus-info-item">
                    <span class="bus-info-label">Bus:</span>
                    <span class="bus-info-value" id="info-bus-number">-</span>
                </div>
                <div class="bus-info-item">
                    <span class="bus-info-label">Route:</span>
                    <span class="bus-info-value" id="info-route-name">-</span>
                </div>
                <div class="bus-info-item">
                    <span class="bus-info-label">Driver:</span>
                    <span class="bus-info-value" id="info-driver-name">-</span>
                </div>
            </div>
        </div>
        
        <div class="bottom-panel">
            <div class="panel-header">
                <div class="panel-title">Tracking Controls</div>
                <button class="panel-toggle" id="log-toggle">
                    <i class="fas fa-chevron-down"></i> Logs
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Connection Settings <span class="preconfigured-badge">Multiple Brokers</span></div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mqtt-broker">MQTT Broker</label>
                        <input type="text" id="mqtt-broker" placeholder="wss://broker.emqx.io:8084/mqtt" value="wss://test.mosquitto.org:8081/mqtt">
                    </div>
                    <div class="form-group">
                        <label for="driver-id">Driver ID</label>
                        <input type="text" id="driver-id" placeholder="DRV-001" value="BUS-DRIVER-001">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mqtt-username">Username</label>
                        <input type="text" id="mqtt-username" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label for="mqtt-password">Password</label>
                        <input type="password" id="mqtt-password" placeholder="Password">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="publish-topic">Publish Topic</label>
                        <input type="text" id="publish-topic" placeholder="schoolbus/driver/location" value="schoolbus/driver/location">
                    </div>
                    <div class="form-group">
                        <label for="subscribe-topic">Subscribe Topic</label>
                        <input type="text" id="subscribe-topic" placeholder="schoolbus/dispatch/commands" value="schoolbus/dispatch/commands">
                    </div>
                </div>
                
                <div class="connection-test">
                    <div>Test Connection: Try different brokers if one fails</div>
                    <button class="test-btn" id="test-emqx">EMQX</button>
                    <button class="test-btn" id="test-mosquitto">Mosquitto</button>
                    <button class="test-btn" id="test-hivemq">HiveMQ</button>
                    <button class="debug-btn" id="test-connectivity">Test Connectivity</button>
                </div>
                
                <div class="btn-group">
                    <button id="connect-btn" class="btn-primary">
                        <i class="fas fa-plug"></i> Connect to Mosquitto
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Bus Information</div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bus-number">Bus Number</label>
                        <input type="text" id="bus-number" placeholder="BUS-12" value="BUS-12">
                    </div>
                    <div class="form-group">
                        <label for="route-name">Route Name</label>
                        <input type="text" id="route-name" placeholder="Route A" value="Route A">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="driver-name">Driver Name</label>
                    <input type="text" id="driver-name" placeholder="Your Name" value="John Driver">
                </div>
            </div>
            
            <div class="tracking-controls">
                <button id="start-tracking-btn" class="btn-primary tracking-btn" disabled>
                    <i class="fas fa-play"></i> Start Tracking
                </button>
                <button id="stop-tracking-btn" class="btn-danger tracking-btn" disabled>
                    <i class="fas fa-stop"></i> Stop
                </button>
            </div>
            
            <div class="log-panel" id="log-panel">
                <div class="log-header">Recent Activity</div>
                <div class="log-entries" id="log-entries">
                    <!-- Log entries will be added here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="close-btn">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="gps-interval">GPS Update Interval</label>
                <select id="gps-interval">
                    <option value="2000">2 seconds</option>
                    <option value="3000" selected>3 seconds</option>
                    <option value="5000">5 seconds</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="map-style">Map Style</label>
                <select id="map-style">
                    <option value="streets">Streets</option>
                    <option value="satellite">Satellite</option>
                    <option value="light">Light</option>
                    <option value="dark" selected>Dark</option>
                </select>
            </div>
            
            <div class="modal-footer">
                <button id="save-settings" class="btn-primary">Save Settings</button>
                <button id="clear-data" class="btn-secondary">Clear Data</button>
            </div>
        </div>
    </div>

    <script>
        // Application state
        const appState = {
            mqttConnected: false,
            trackingActive: false,
            currentLocation: null,
            locationWatcher: null,
            mqttClient: null,
            map: null,
            busMarker: null,
            logEntries: [],
            settings: {
                gpsInterval: 3000,
                mapStyle: 'dark'
            },
            busInfo: {
                busNumber: '',
                routeName: '',
                driverName: ''
            }
        };

        // Alternative MQTT brokers for testing
        const brokerOptions = {
            emqx: {
                name: "EMQX",
                url: "wss://broker.emqx.io:8084/mqtt",
                port: 8084
            },
            mosquitto: {
                name: "Mosquitto",
                url: "wss://test.mosquitto.org:8081/mqtt",
                port: 8081
            },
            hivemq: {
                name: "HiveMQ",
                url: "wss://broker.hivemq.com:8884/mqtt",
                port: 8884
            },
            emqx_alternative: {
                name: "EMQX WS",
                url: "ws://broker.emqx.io:8083/mqtt",
                port: 8083
            }
        };

        // DOM elements
        const elements = {
            connectionStatus: document.getElementById('connection-status'),
            trackingStatus: document.getElementById('tracking-status'),
            connectionIndicator: document.getElementById('connection-indicator'),
            trackingIndicator: document.getElementById('tracking-indicator'),
            connectBtn: document.getElementById('connect-btn'),
            startTrackingBtn: document.getElementById('start-tracking-btn'),
            stopTrackingBtn: document.getElementById('stop-tracking-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            helpBtn: document.getElementById('help-btn'),
            logToggle: document.getElementById('log-toggle'),
            map: document.getElementById('map'),
            logEntries: document.getElementById('log-entries'),
            logPanel: document.getElementById('log-panel'),
            settingsModal: document.getElementById('settings-modal'),
            closeModalBtn: document.querySelector('.close-btn'),
            saveSettingsBtn: document.getElementById('save-settings'),
            clearDataBtn: document.getElementById('clear-data'),
            gpsInterval: document.getElementById('gps-interval'),
            mapStyle: document.getElementById('map-style'),
            infoBusNumber: document.getElementById('info-bus-number'),
            infoRouteName: document.getElementById('info-route-name'),
            infoDriverName: document.getElementById('info-driver-name'),
            testEmqx: document.getElementById('test-emqx'),
            testMosquitto: document.getElementById('test-mosquitto'),
            testHivemq: document.getElementById('test-hivemq'),
            testConnectivity: document.getElementById('test-connectivity')
        };

        // Input elements
        const inputs = {
            busNumber: document.getElementById('bus-number'),
            routeName: document.getElementById('route-name'),
            driverName: document.getElementById('driver-name'),
            driverId: document.getElementById('driver-id'),
            mqttBroker: document.getElementById('mqtt-broker'),
            mqttUsername: document.getElementById('mqtt-username'),
            mqttPassword: document.getElementById('mqtt-password'),
            publishTopic: document.getElementById('publish-topic'),
            subscribeTopic: document.getElementById('subscribe-topic')
        };

        // Initialize the application
        function initApp() {
            // Enable MQTT debugging
            Paho.MQTT.logging = function(message) {
                console.log('MQTT Debug:', message);
            };
            
            setDefaultConfig();
            loadSettings();
            initMap();
            setupEventListeners();
            updateUI();
            updateBusInfo();
            addLogEntry('App started with Mosquitto broker pre-configured');
        }

        // Set default Mosquitto configuration (more reliable)
        function setDefaultConfig() {
            inputs.mqttBroker.value = brokerOptions.mosquitto.url;
            inputs.driverId.value = "BUS-DRIVER-001";
            inputs.publishTopic.value = "schoolbus/driver/location";
            inputs.subscribeTopic.value = "schoolbus/dispatch/commands";
            inputs.busNumber.value = "BUS-12";
            inputs.routeName.value = "Route A";
            inputs.driverName.value = "John Driver";
            
            // Clear username and password for public broker
            inputs.mqttUsername.value = "";
            inputs.mqttPassword.value = "";
        }

        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('busTrackerSettings');
            if (savedSettings) {
                appState.settings = { ...appState.settings, ...JSON.parse(savedSettings) };
            }
            
            // Load form values from localStorage (only if they exist)
            for (const key in inputs) {
                const savedValue = localStorage.getItem(`busTracker_${key}`);
                if (savedValue && inputs[key]) {
                    inputs[key].value = savedValue;
                }
            }
            
            // Apply settings to UI
            if (elements.gpsInterval) elements.gpsInterval.value = appState.settings.gpsInterval;
            if (elements.mapStyle) elements.mapStyle.value = appState.settings.mapStyle;
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('busTrackerSettings', JSON.stringify(appState.settings));
            
            // Save form values
            for (const key in inputs) {
                if (inputs[key].value) {
                    localStorage.setItem(`busTracker_${key}`, inputs[key].value);
                }
            }
        }

        // Initialize the map
        function initMap() {
            const defaultLocation = [39.8283, -98.5795];
            
            let tileLayerUrl;
            switch(appState.settings.mapStyle) {
                case 'satellite':
                    tileLayerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                    break;
                case 'light':
                    tileLayerUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
                    break;
                case 'dark':
                    tileLayerUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png';
                    break;
                default:
                    tileLayerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            }
            
            appState.map = L.map('map').setView(defaultLocation, 5);
            
            L.tileLayer(tileLayerUrl, {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(appState.map);
            
            // Create a custom bus icon
            const busIcon = L.divIcon({
                className: 'bus-marker',
                html: '<div style="background-color: #FFC632; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;"><i class="fas fa-bus" style="color: #1A1D29; font-size: 10px;"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // Add initial marker
            appState.busMarker = L.marker(defaultLocation, { icon: busIcon })
                .addTo(appState.map)
                .bindPopup('Bus location will appear here');
        }

        // Set up event listeners
        function setupEventListeners() {
            elements.connectBtn.addEventListener('click', toggleMQTTConnection);
            elements.startTrackingBtn.addEventListener('click', startTracking);
            elements.stopTrackingBtn.addEventListener('click', stopTracking);
            elements.settingsBtn.addEventListener('click', showSettingsModal);
            elements.helpBtn.addEventListener('click', showHelp);
            elements.closeModalBtn.addEventListener('click', hideSettingsModal);
            elements.saveSettingsBtn.addEventListener('click', saveAppSettings);
            elements.clearDataBtn.addEventListener('click', clearAllData);
            elements.logToggle.addEventListener('click', toggleLogPanel);
            elements.testEmqx.addEventListener('click', () => testBroker('emqx'));
            elements.testMosquitto.addEventListener('click', () => testBroker('mosquitto'));
            elements.testHivemq.addEventListener('click', () => testBroker('hivemq'));
            elements.testConnectivity.addEventListener('click', testConnectivity);
            
            // Update bus info when inputs change
            for (const key in inputs) {
                if (inputs[key] && ['busNumber', 'routeName', 'driverName'].includes(key)) {
                    inputs[key].addEventListener('input', updateBusInfo);
                }
            }
            
            // Close modal when clicking outside
            elements.settingsModal.addEventListener('click', (e) => {
                if (e.target === elements.settingsModal) {
                    hideSettingsModal();
                }
            });
        }

        // Test alternative broker
        function testBroker(brokerKey) {
            const broker = brokerOptions[brokerKey];
            if (broker) {
                inputs.mqttBroker.value = broker.url;
                addLogEntry(`Switched to ${broker.name} broker`);
                // Auto-connect after switching
                setTimeout(() => {
                    if (!appState.mqttConnected) {
                        connectMQTT();
                    }
                }, 500);
            }
        }

        // Test WebSocket connectivity
        function testConnectivity() {
            addLogEntry('üß™ Testing WebSocket connectivity...');
            
            const testUrl = inputs.mqttBroker.value;
            addLogEntry(`Testing connection to: ${testUrl}`);
            
            try {
                const testWs = new WebSocket(testUrl);
                
                testWs.onopen = function() {
                    addLogEntry('‚úÖ WebSocket connection successful');
                    testWs.close();
                };
                
                testWs.onerror = function(error) {
                    addLogEntry('‚ùå WebSocket connection failed');
                    console.error('WebSocket test error:', error);
                };
                
                testWs.onclose = function() {
                    addLogEntry('üîå WebSocket test connection closed');
                };
                
                // Timeout after 5 seconds
                setTimeout(() => {
                    if (testWs.readyState !== WebSocket.OPEN) {
                        addLogEntry('‚è∞ WebSocket test timeout');
                        testWs.close();
                    }
                }, 5000);
                
            } catch (error) {
                addLogEntry(`‚ùå WebSocket test error: ${error.message}`);
            }
        }

        // Update UI based on app state
        function updateUI() {
            if (appState.mqttConnected) {
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionIndicator.className = 'status-indicator status-connected status-pulse';
                elements.connectBtn.innerHTML = '<i class="fas fa-plug"></i> Disconnect';
                elements.connectBtn.classList.remove('btn-primary');
                elements.connectBtn.classList.add('btn-secondary');
                elements.startTrackingBtn.disabled = false;
            } else {
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionIndicator.className = 'status-indicator status-disconnected';
                const currentBroker = getCurrentBrokerName();
                elements.connectBtn.innerHTML = `<i class="fas fa-plug"></i> Connect to ${currentBroker}`;
                elements.connectBtn.classList.remove('btn-secondary');
                elements.connectBtn.classList.add('btn-primary');
                elements.startTrackingBtn.disabled = true;
                elements.stopTrackingBtn.disabled = true;
            }
            
            if (appState.trackingActive) {
                elements.trackingStatus.textContent = 'Tracking Active';
                elements.trackingIndicator.className = 'status-indicator status-tracking status-pulse';
                elements.startTrackingBtn.disabled = true;
                elements.stopTrackingBtn.disabled = false;
            } else {
                elements.trackingStatus.textContent = 'Not Tracking';
                elements.trackingIndicator.className = 'status-indicator status-idle';
                elements.startTrackingBtn.disabled = !appState.mqttConnected;
                elements.stopTrackingBtn.disabled = true;
            }
        }

        // Get current broker name for display
        function getCurrentBrokerName() {
            const currentUrl = inputs.mqttBroker.value;
            for (const key in brokerOptions) {
                if (brokerOptions[key].url === currentUrl) {
                    return brokerOptions[key].name;
                }
            }
            return 'MQTT';
        }

        // Update bus info display
        function updateBusInfo() {
            appState.busInfo.busNumber = inputs.busNumber.value || '-';
            appState.busInfo.routeName = inputs.routeName.value || '-';
            appState.busInfo.driverName = inputs.driverName.value || '-';
            
            elements.infoBusNumber.textContent = appState.busInfo.busNumber;
            elements.infoRouteName.textContent = appState.busInfo.routeName;
            elements.infoDriverName.textContent = appState.busInfo.driverName;
        }

        // Toggle MQTT connection
        function toggleMQTTConnection() {
            if (appState.mqttConnected) {
                disconnectMQTT();
            } else {
                connectMQTT();
            }
        }

        // Connect to MQTT broker
        function connectMQTT() {
            const brokerUrl = inputs.mqttBroker.value;
            const username = inputs.mqttUsername.value;
            const password = inputs.mqttPassword.value;
            
            if (!brokerUrl) {
                alert('Please enter MQTT broker URL');
                return;
            }
            
            // Disconnect first if already connected
            if (appState.mqttClient && appState.mqttClient.isConnected()) {
                appState.mqttClient.disconnect();
            }
            
            try {
                // Extract host and port from URL
                const url = new URL(brokerUrl);
                const host = url.hostname;
                const port = parseInt(url.port) || (url.protocol === 'wss:' ? 443 : 80);
                const path = url.pathname;
                
                // Generate a more unique client ID
                const clientId = `bus_driver_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                console.log('Connecting to:', { host, port, path, clientId });
                
                // Create MQTT client
                appState.mqttClient = new Paho.MQTT.Client(host, port, path, clientId);
                
                // Set callback handlers
                appState.mqttClient.onConnectionLost = onConnectionLost;
                appState.mqttClient.onMessageArrived = onMessageArrived;
                
                // Improved connection options
                const connectOptions = {
                    onSuccess: onConnect,
                    onFailure: onConnectFailure,
                    userName: username || undefined,
                    password: password || undefined,
                    useSSL: brokerUrl.startsWith('wss://'),
                    timeout: 30, // Increased timeout
                    keepAliveInterval: 60,
                    cleanSession: true,
                    reconnect: true,
                    mqttVersion: 4, // MQTT 3.1.1
                    mqttVersionExplicit: false
                };
                
                // Remove empty credentials
                if (!username) delete connectOptions.userName;
                if (!password) delete connectOptions.password;
                
                // Connect the client
                appState.mqttClient.connect(connectOptions);
                
                // Update UI to show connecting state
                elements.connectionStatus.textContent = 'Connecting...';
                elements.connectBtn.disabled = true;
                addLogEntry(`üîó Connecting to ${getCurrentBrokerName()} broker...`);
                
            } catch (error) {
                console.error('MQTT connection error:', error);
                handleConnectionError(error);
            }
        }

        // MQTT connection success callback
        function onConnect() {
            appState.mqttConnected = true;
            addLogEntry('‚úÖ Successfully connected to MQTT broker');
            
            // Subscribe to topic
            const subscribeTopic = inputs.subscribeTopic.value;
            if (subscribeTopic) {
                try {
                    appState.mqttClient.subscribe(subscribeTopic, {qos: 0});
                    addLogEntry(`üì° Subscribed to topic: ${subscribeTopic}`);
                } catch (error) {
                    addLogEntry('‚ùå Failed to subscribe: ' + error.message);
                }
            }
            
            updateUI();
            saveSettings();
        }

        // MQTT connection failure callback
        function onConnectFailure(error) {
            handleConnectionError(error);
        }

        // Handle connection errors
        function handleConnectionError(error) {
            let errorMessage = 'Unknown error';
            
            if (error && error.errorCode !== undefined) {
                // Paho MQTT specific error codes
                switch(error.errorCode) {
                    case 0: errorMessage = 'Connection successful'; break;
                    case 1: errorMessage = 'Connection refused: Unacceptable protocol version'; break;
                    case 2: errorMessage = 'Connection refused: Identifier rejected'; break;
                    case 3: errorMessage = 'Connection refused: Server unavailable'; break;
                    case 4: errorMessage = 'Connection refused: Bad username or password'; break;
                    case 5: errorMessage = 'Connection refused: Not authorized'; break;
                    case 6: errorMessage = 'Connection lost'; break;
                    case 7: errorMessage = 'Timeout'; break;
                    default: errorMessage = `Error code: ${error.errorCode}`;
                }
            } else if (error && error.errorMessage) {
                errorMessage = error.errorMessage;
            } else if (error && error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            }
            
            console.error('Connection failed:', errorMessage);
            addLogEntry(`‚ùå Connection failed: ${errorMessage}`);
            
            // Show helpful suggestions based on error
            let suggestion = '';
            if (errorMessage.includes('WebSocket') || errorMessage.includes('ws')) {
                suggestion = '\n\nPossible solutions:\n‚Ä¢ Check internet connection\n‚Ä¢ Try a different broker\n‚Ä¢ The broker might be temporarily unavailable\n‚Ä¢ Try accessing via HTTPS instead of HTTP';
            } else if (errorMessage.includes('SecurityError') || errorMessage.includes('CORS')) {
                suggestion = '\n\nPossible solutions:\n‚Ä¢ Try accessing via HTTPS\n‚Ä¢ The broker might not support WebSockets from browser\n‚Ä¢ Try a different broker like HiveMQ';
            } else if (errorMessage.includes('Timeout')) {
                suggestion = '\n\nPossible solutions:\n‚Ä¢ Broker might be down\n‚Ä¢ Firewall blocking connection\n‚Ä¢ Try a different broker';
            }
            
            alert(`Failed to connect to MQTT broker: ${errorMessage}${suggestion}`);
            
            elements.connectBtn.disabled = false;
            elements.connectionStatus.textContent = 'Connection Failed';
        }

        // MQTT connection lost callback
        function onConnectionLost(response) {
            if (response.errorCode !== 0) {
                addLogEntry(`üîå Connection lost: ${response.errorMessage}`);
            } else {
                addLogEntry('üîå Connection closed');
            }
            
            appState.mqttConnected = false;
            updateUI();
            
            if (appState.trackingActive) {
                stopTracking();
            }
        }

        // MQTT message received callback
        function onMessageArrived(message) {
            try {
                const payload = JSON.parse(message.payloadString);
                addLogEntry(`üì® Received: ${payload.driver_id || 'Unknown'} at ${payload.lat}, ${payload.lng}`);
            } catch (error) {
                addLogEntry(`üì® Received message: ${message.payloadString}`);
            }
        }

        // Disconnect from MQTT
        function disconnectMQTT() {
            if (appState.mqttClient) {
                try {
                    appState.mqttClient.disconnect();
                } catch (error) {
                    console.error('Error during disconnect:', error);
                }
                appState.mqttClient = null;
            }
            
            appState.mqttConnected = false;
            
            if (appState.trackingActive) {
                stopTracking();
            }
            
            updateUI();
            addLogEntry('üîå Disconnected from MQTT broker');
        }

        // Start GPS tracking
        function startTracking() {
            if (!appState.mqttConnected) {
                alert('Please connect to MQTT first');
                return;
            }
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    appState.locationWatcher = navigator.geolocation.watchPosition(
                        onLocationUpdate,
                        onLocationError,
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                    
                    appState.trackingActive = true;
                    updateUI();
                    addLogEntry('üìç Started GPS tracking');
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    onLocationUpdate(position);
                },
                (error) => {
                    alert('Error getting location: ' + error.message);
                    addLogEntry('‚ùå GPS error: ' + error.message);
                }
            );
        }

        // Location update handler
        function onLocationUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            appState.currentLocation = { lat, lng };
            
            if (appState.busMarker) {
                appState.busMarker.setLatLng([lat, lng]);
                appState.busMarker.bindPopup(`Bus Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();
                
                if (!appState.mapCentered) {
                    appState.map.setView([lat, lng], 15);
                    appState.mapCentered = true;
                }
            }
            
            if (appState.mqttConnected) {
                publishLocation(lat, lng);
            }
        }

        // Location error handler
        function onLocationError(error) {
            console.error('Geolocation error:', error);
            addLogEntry('‚ùå GPS error: ' + error.message);
        }

        // Publish location to MQTT
        function publishLocation(lat, lng) {
            if (!appState.mqttConnected || !appState.mqttClient) {
                return;
            }
            
            const publishTopic = inputs.publishTopic.value;
            if (!publishTopic) {
                addLogEntry('‚ùå Error: No publish topic specified');
                return;
            }
            
            const message = {
                driver_id: inputs.driverId.value || 'unknown',
                bus_number: inputs.busNumber.value || 'unknown',
                route_name: inputs.routeName.value || 'unknown',
                driver_name: inputs.driverName.value || 'unknown',
                lat: lat,
                lng: lng,
                timestamp: new Date().toISOString(),
                speed: 0,
                heading: 0
            };
            
            try {
                const mqttMessage = new Paho.MQTT.Message(JSON.stringify(message));
                mqttMessage.destinationName = publishTopic;
                mqttMessage.qos = 0;
                
                appState.mqttClient.send(mqttMessage);
                
                addLogEntry(`üì§ Published location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            } catch (error) {
                addLogEntry('‚ùå Failed to publish: ' + error.message);
            }
        }

        // Stop GPS tracking
        function stopTracking() {
            if (appState.locationWatcher) {
                navigator.geolocation.clearWatch(appState.locationWatcher);
                appState.locationWatcher = null;
            }
            
            appState.trackingActive = false;
            updateUI();
            addLogEntry('üõë Stopped GPS tracking');
        }

        // Add entry to tracking log
        function addLogEntry(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message };
            
            appState.logEntries.unshift(entry);
            
            if (appState.logEntries.length > 10) {
                appState.logEntries.pop();
            }
            
            updateLogDisplay();
        }

        // Update log display
        function updateLogDisplay() {
            elements.logEntries.innerHTML = '';
            
            appState.logEntries.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-time">[${entry.timestamp}]</span> ${entry.message}
                `;
                elements.logEntries.appendChild(logEntry);
            });
        }

        // Toggle log panel visibility
        function toggleLogPanel() {
            elements.logPanel.classList.toggle('expanded');
            const icon = elements.logToggle.querySelector('i');
            if (elements.logPanel.classList.contains('expanded')) {
                icon.className = 'fas fa-chevron-up';
            } else {
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Show settings modal
        function showSettingsModal() {
            elements.settingsModal.style.display = 'flex';
        }

        // Hide settings modal
        function hideSettingsModal() {
            elements.settingsModal.style.display = 'none';
        }

        // Show help information
        function showHelp() {
            alert('üöå School Bus Tracker Help:\n\nüì° CONNECTION:\n- Mosquitto broker is pre-configured (most reliable)\n- If connection fails, try alternative brokers\n- No username/password required for public brokers\n\nüìç TRACKING:\n- Connect first, then start tracking\n- Location updates every 3 seconds\n- Data is published to MQTT topic\n\n‚öôÔ∏è TROUBLESHOOTING:\n- Try different brokers if one fails\n- Check internet connection\n- Ensure browser has location permissions\n- Use "Test Connectivity" to check WebSocket connection');
        }

        // Save app settings
        function saveAppSettings() {
            appState.settings.gpsInterval = parseInt(elements.gpsInterval.value);
            appState.settings.mapStyle = elements.mapStyle.value;
            
            saveSettings();
            hideSettingsModal();
            addLogEntry('‚öôÔ∏è Settings saved');
            
            if (appState.map) {
                appState.map.remove();
                initMap();
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all saved data?\n\nThis will reset all settings to default but keep the Mosquitto broker configuration.')) {
                localStorage.clear();
                appState.logEntries = [];
                updateLogDisplay();
                
                setDefaultConfig();
                
                addLogEntry('üóëÔ∏è All data cleared, Mosquitto configuration restored');
                hideSettingsModal();
                updateBusInfo();
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
