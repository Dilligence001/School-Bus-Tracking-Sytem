<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bus Tracker - Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #21D375; /* Bolt green */
            --primary-dark: #1BB863;
            --secondary: #FFC632; /* School bus yellow */
            --dark: #1A1D29;
            --darker: #12141C;
            --light: #F8F9FA;
            --gray: #8E8E93;
            --gray-dark: #636366;
            --card-bg: #252836;
            --danger: #FF3B30;
            --warning: #FF9500;
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--darker);
            color: var(--light);
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        /* Header Styles - Bolt inspired */
        header {
            background-color: var(--dark);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            background-color: var(--primary);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .header-icon {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Main Container */
        .container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 66px);
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: var(--dark);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-connected {
            background-color: var(--primary);
        }
        
        .status-disconnected {
            background-color: var(--danger);
        }
        
        .status-tracking {
            background-color: var(--warning);
        }
        
        .status-idle {
            background-color: var(--gray);
        }
        
        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            min-height: 300px;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Bottom Panel - Bolt style */
        .bottom-panel {
            background-color: var(--dark);
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 500;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .panel-toggle {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1rem;
            cursor: pointer;
        }
        
        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .card-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--light);
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Button Styles - Bolt inspired */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:active {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--light);
        }
        
        .btn-secondary:active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tracking Controls */
        .tracking-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tracking-btn {
            flex: 1;
            padding: 18px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        /* Log Panel */
        .log-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .log-panel.expanded {
            max-height: 200px;
        }
        
        .log-header {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .log-entries {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }
        
        .log-time {
            color: var(--primary);
            font-size: 0.7rem;
            margin-right: 8px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--dark);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Bus Info Panel */
        .bus-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--dark);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            z-index: 400;
            box-shadow: var(--shadow);
            max-width: 200px;
        }
        
        .bus-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .bus-info-label {
            color: var(--gray);
        }
        
        .bus-info-value {
            font-weight: 500;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .tracking-controls {
                flex-direction: column;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        /* Animation for connection status */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-pulse {
            animation: pulse 2s infinite;
        }
        
        /* Pre-configured badge */
        .preconfigured-badge {
            background-color: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-bus"></i>
            </div>
            <div class="logo-text">School Bus Tracker</div>
        </div>
        <div class="header-actions">
            <button class="header-icon" id="settings-btn">
                <i class="fas fa-cog"></i>
            </button>
            <button class="header-icon" id="help-btn">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    </header>
    
    <div class="container">
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-disconnected" id="connection-indicator"></div>
                <span id="connection-status">Disconnected</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-idle" id="tracking-indicator"></div>
                <span id="tracking-status">Not Tracking</span>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="bus-info">
                <div class="bus-info-item">
                    <span class="bus-info-label">Bus:</span>
                    <span class="bus-info-value" id="info-bus-number">-</span>
                </div>
                <div class="bus-info-item">
                    <span class="bus-info-label">Route:</span>
                    <span class="bus-info-value" id="info-route-name">-</span>
                </div>
                <div class="bus-info-item">
                    <span class="bus-info-label">Driver:</span>
                    <span class="bus-info-value" id="info-driver-name">-</span>
                </div>
            </div>
        </div>
        
        <div class="bottom-panel">
            <div class="panel-header">
                <div class="panel-title">Tracking Controls</div>
                <button class="panel-toggle" id="log-toggle">
                    <i class="fas fa-chevron-down"></i> Logs
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Connection Settings <span class="preconfigured-badge">EMQX Pre-configured</span></div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mqtt-broker">MQTT Broker</label>
                        <input type="text" id="mqtt-broker" placeholder="wss://broker.emqx.io:8084/mqtt" value="wss://broker.emqx.io:8084/mqtt">
                    </div>
                    <div class="form-group">
                        <label for="driver-id">Driver ID</label>
                        <input type="text" id="driver-id" placeholder="DRV-001" value="BUS-DRIVER-001">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mqtt-username">Username</label>
                        <input type="text" id="mqtt-username" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label for="mqtt-password">Password</label>
                        <input type="password" id="mqtt-password" placeholder="Password">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="publish-topic">Publish Topic</label>
                        <input type="text" id="publish-topic" placeholder="schoolbus/driver/location" value="schoolbus/driver/location">
                    </div>
                    <div class="form-group">
                        <label for="subscribe-topic">Subscribe Topic</label>
                        <input type="text" id="subscribe-topic" placeholder="schoolbus/dispatch/commands" value="schoolbus/dispatch/commands">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="connect-btn" class="btn-primary">
                        <i class="fas fa-plug"></i> Connect to EMQX
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Bus Information</div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bus-number">Bus Number</label>
                        <input type="text" id="bus-number" placeholder="BUS-12" value="BUS-12">
                    </div>
                    <div class="form-group">
                        <label for="route-name">Route Name</label>
                        <input type="text" id="route-name" placeholder="Route A" value="Route A">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="driver-name">Driver Name</label>
                    <input type="text" id="driver-name" placeholder="Your Name" value="John Driver">
                </div>
            </div>
            
            <div class="tracking-controls">
                <button id="start-tracking-btn" class="btn-primary tracking-btn" disabled>
                    <i class="fas fa-play"></i> Start Tracking
                </button>
                <button id="stop-tracking-btn" class="btn-danger tracking-btn" disabled>
                    <i class="fas fa-stop"></i> Stop
                </button>
            </div>
            
            <div class="log-panel" id="log-panel">
                <div class="log-header">Recent Activity</div>
                <div class="log-entries" id="log-entries">
                    <!-- Log entries will be added here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="close-btn">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="gps-interval">GPS Update Interval</label>
                <select id="gps-interval">
                    <option value="2000">2 seconds</option>
                    <option value="3000" selected>3 seconds</option>
                    <option value="5000">5 seconds</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="map-style">Map Style</label>
                <select id="map-style">
                    <option value="streets">Streets</option>
                    <option value="satellite">Satellite</option>
                    <option value="light">Light</option>
                    <option value="dark" selected>Dark</option>
                </select>
            </div>
            
            <div class="modal-footer">
                <button id="save-settings" class="btn-primary">Save Settings</button>
                <button id="clear-data" class="btn-secondary">Clear Data</button>
            </div>
        </div>
    </div>

    <script>
        // Application state
        const appState = {
            mqttConnected: false,
            trackingActive: false,
            currentLocation: null,
            locationWatcher: null,
            mqttClient: null,
            map: null,
            busMarker: null,
            logEntries: [],
            settings: {
                gpsInterval: 3000,
                mapStyle: 'dark'
            },
            busInfo: {
                busNumber: '',
                routeName: '',
                driverName: ''
            }
        };

        // Default configuration for EMQX broker
        const defaultConfig = {
            broker: "wss://broker.emqx.io:8084/mqtt",
            username: "",
            password: "",
            publishTopic: "schoolbus/driver/location",
            subscribeTopic: "schoolbus/dispatch/commands",
            busNumber: "BUS-12",
            routeName: "Route A",
            driverName: "John Driver",
            driverId: "BUS-DRIVER-001"
        };

        // DOM elements
        const elements = {
            connectionStatus: document.getElementById('connection-status'),
            trackingStatus: document.getElementById('tracking-status'),
            connectionIndicator: document.getElementById('connection-indicator'),
            trackingIndicator: document.getElementById('tracking-indicator'),
            connectBtn: document.getElementById('connect-btn'),
            startTrackingBtn: document.getElementById('start-tracking-btn'),
            stopTrackingBtn: document.getElementById('stop-tracking-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            helpBtn: document.getElementById('help-btn'),
            logToggle: document.getElementById('log-toggle'),
            map: document.getElementById('map'),
            logEntries: document.getElementById('log-entries'),
            logPanel: document.getElementById('log-panel'),
            settingsModal: document.getElementById('settings-modal'),
            closeModalBtn: document.querySelector('.close-btn'),
            saveSettingsBtn: document.getElementById('save-settings'),
            clearDataBtn: document.getElementById('clear-data'),
            gpsInterval: document.getElementById('gps-interval'),
            mapStyle: document.getElementById('map-style'),
            infoBusNumber: document.getElementById('info-bus-number'),
            infoRouteName: document.getElementById('info-route-name'),
            infoDriverName: document.getElementById('info-driver-name')
        };

        // Input elements
        const inputs = {
            busNumber: document.getElementById('bus-number'),
            routeName: document.getElementById('route-name'),
            driverName: document.getElementById('driver-name'),
            driverId: document.getElementById('driver-id'),
            mqttBroker: document.getElementById('mqtt-broker'),
            mqttUsername: document.getElementById('mqtt-username'),
            mqttPassword: document.getElementById('mqtt-password'),
            publishTopic: document.getElementById('publish-topic'),
            subscribeTopic: document.getElementById('subscribe-topic')
        };

        // Initialize the application
        function initApp() {
            setDefaultConfig();
            loadSettings();
            initMap();
            setupEventListeners();
            updateUI();
            updateBusInfo();
            addLogEntry('App started with EMQX broker pre-configured');
        }

        // Set default EMQX configuration
        function setDefaultConfig() {
            inputs.mqttBroker.value = defaultConfig.broker;
            inputs.driverId.value = defaultConfig.driverId;
            inputs.publishTopic.value = defaultConfig.publishTopic;
            inputs.subscribeTopic.value = defaultConfig.subscribeTopic;
            inputs.busNumber.value = defaultConfig.busNumber;
            inputs.routeName.value = defaultConfig.routeName;
            inputs.driverName.value = defaultConfig.driverName;
            
            // Clear username and password for public broker
            inputs.mqttUsername.value = defaultConfig.username;
            inputs.mqttPassword.value = defaultConfig.password;
        }

        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('busTrackerSettings');
            if (savedSettings) {
                appState.settings = { ...appState.settings, ...JSON.parse(savedSettings) };
            }
            
            // Load form values from localStorage (only if they exist)
            for (const key in inputs) {
                const savedValue = localStorage.getItem(`busTracker_${key}`);
                if (savedValue && inputs[key]) {
                    inputs[key].value = savedValue;
                }
            }
            
            // Apply settings to UI
            if (elements.gpsInterval) elements.gpsInterval.value = appState.settings.gpsInterval;
            if (elements.mapStyle) elements.mapStyle.value = appState.settings.mapStyle;
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('busTrackerSettings', JSON.stringify(appState.settings));
            
            // Save form values
            for (const key in inputs) {
                if (inputs[key].value) {
                    localStorage.setItem(`busTracker_${key}`, inputs[key].value);
                }
            }
        }

        // Initialize the map
        function initMap() {
            // Default to a central US location if GPS not available yet
            const defaultLocation = [39.8283, -98.5795];
            
            // Determine which map tiles to use based on settings
            let tileLayerUrl;
            switch(appState.settings.mapStyle) {
                case 'satellite':
                    tileLayerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                    break;
                case 'light':
                    tileLayerUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
                    break;
                case 'dark':
                    tileLayerUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png';
                    break;
                default: // streets
                    tileLayerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            }
            
            appState.map = L.map('map').setView(defaultLocation, 5);
            
            L.tileLayer(tileLayerUrl, {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(appState.map);
            
            // Create a custom bus icon
            const busIcon = L.divIcon({
                className: 'bus-marker',
                html: '<div style="background-color: #FFC632; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;"><i class="fas fa-bus" style="color: #1A1D29; font-size: 10px;"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // Add initial marker
            appState.busMarker = L.marker(defaultLocation, { icon: busIcon })
                .addTo(appState.map)
                .bindPopup('Bus location will appear here');
        }

        // Set up event listeners
        function setupEventListeners() {
            elements.connectBtn.addEventListener('click', toggleMQTTConnection);
            elements.startTrackingBtn.addEventListener('click', startTracking);
            elements.stopTrackingBtn.addEventListener('click', stopTracking);
            elements.settingsBtn.addEventListener('click', showSettingsModal);
            elements.helpBtn.addEventListener('click', showHelp);
            elements.closeModalBtn.addEventListener('click', hideSettingsModal);
            elements.saveSettingsBtn.addEventListener('click', saveAppSettings);
            elements.clearDataBtn.addEventListener('click', clearAllData);
            elements.logToggle.addEventListener('click', toggleLogPanel);
            
            // Update bus info when inputs change
            for (const key in inputs) {
                if (inputs[key] && ['busNumber', 'routeName', 'driverName'].includes(key)) {
                    inputs[key].addEventListener('input', updateBusInfo);
                }
            }
            
            // Close modal when clicking outside
            elements.settingsModal.addEventListener('click', (e) => {
                if (e.target === elements.settingsModal) {
                    hideSettingsModal();
                }
            });
        }

        // Update UI based on app state
        function updateUI() {
            // Update connection status
            if (appState.mqttConnected) {
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionIndicator.className = 'status-indicator status-connected status-pulse';
                elements.connectBtn.innerHTML = '<i class="fas fa-plug"></i> Disconnect';
                elements.connectBtn.classList.remove('btn-primary');
                elements.connectBtn.classList.add('btn-secondary');
                elements.startTrackingBtn.disabled = false;
            } else {
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionIndicator.className = 'status-indicator status-disconnected';
                elements.connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect to EMQX';
                elements.connectBtn.classList.remove('btn-secondary');
                elements.connectBtn.classList.add('btn-primary');
                elements.startTrackingBtn.disabled = true;
                elements.stopTrackingBtn.disabled = true;
            }
            
            // Update tracking status
            if (appState.trackingActive) {
                elements.trackingStatus.textContent = 'Tracking Active';
                elements.trackingIndicator.className = 'status-indicator status-tracking status-pulse';
                elements.startTrackingBtn.disabled = true;
                elements.stopTrackingBtn.disabled = false;
            } else {
                elements.trackingStatus.textContent = 'Not Tracking';
                elements.trackingIndicator.className = 'status-indicator status-idle';
                elements.startTrackingBtn.disabled = !appState.mqttConnected;
                elements.stopTrackingBtn.disabled = true;
            }
        }

        // Update bus info display
        function updateBusInfo() {
            appState.busInfo.busNumber = inputs.busNumber.value || '-';
            appState.busInfo.routeName = inputs.routeName.value || '-';
            appState.busInfo.driverName = inputs.driverName.value || '-';
            
            elements.infoBusNumber.textContent = appState.busInfo.busNumber;
            elements.infoRouteName.textContent = appState.busInfo.routeName;
            elements.infoDriverName.textContent = appState.busInfo.driverName;
        }

        // Toggle MQTT connection
        function toggleMQTTConnection() {
            if (appState.mqttConnected) {
                disconnectMQTT();
            } else {
                connectMQTT();
            }
        }

        // Connect to MQTT broker
        function connectMQTT() {
            const brokerUrl = inputs.mqttBroker.value;
            const username = inputs.mqttUsername.value;
            const password = inputs.mqttPassword.value;
            const subscribeTopic = inputs.subscribeTopic.value;
            
            if (!brokerUrl) {
                alert('Please enter MQTT broker URL');
                return;
            }
            
            try {
                // Create MQTT client
                appState.mqttClient = new Paho.MQTT.Client(
                    brokerUrl,
                    `bus_tracker_${Date.now()}`
                );
                
                // Set callback handlers
                appState.mqttClient.onConnectionLost = onConnectionLost;
                appState.mqttClient.onMessageArrived = onMessageArrived;
                
                // Connect the client
                const connectOptions = {
                    onSuccess: onConnect,
                    onFailure: onConnectFailure,
                    userName: username || undefined,
                    password: password || undefined,
                    useSSL: brokerUrl.startsWith('wss://'),
                    timeout: 10, // Connection timeout in seconds
                    keepAliveInterval: 60, // Keep alive interval in seconds
                    cleanSession: true
                };
                
                appState.mqttClient.connect(connectOptions);
                
                // Update UI to show connecting state
                elements.connectionStatus.textContent = 'Connecting to EMQX...';
                elements.connectBtn.disabled = true;
                addLogEntry(`Connecting to EMQX broker: ${brokerUrl}`);
                
            } catch (error) {
                console.error('MQTT connection error:', error);
                addLogEntry('Error connecting to EMQX: ' + error.message);
                alert('Failed to connect to EMQX broker: ' + error.message);
                elements.connectBtn.disabled = false;
            }
        }

        // MQTT connection success callback
        function onConnect() {
            appState.mqttConnected = true;
            addLogEntry('‚úÖ Successfully connected to EMQX broker');
            
            // Subscribe to topic
            const subscribeTopic = inputs.subscribeTopic.value;
            if (subscribeTopic) {
                appState.mqttClient.subscribe(subscribeTopic);
                addLogEntry(`üì° Subscribed to topic: ${subscribeTopic}`);
            }
            
            updateUI();
            saveSettings(); // Save connection details
        }

        // MQTT connection failure callback
        function onConnectFailure(error) {
            console.error('MQTT connection failed:', error);
            addLogEntry('‚ùå Failed to connect to EMQX: ' + error.errorMessage);
            alert('Failed to connect to EMQX broker. Please check:\n\n1. Your internet connection\n2. The broker URL\n3. Firewall settings\n\nError: ' + error.errorMessage);
            elements.connectBtn.disabled = false;
            elements.connectionStatus.textContent = 'Connection Failed';
        }

        // MQTT connection lost callback
        function onConnectionLost(response) {
            if (response.errorCode !== 0) {
                console.error('MQTT connection lost:', response.errorMessage);
                addLogEntry('üîå Connection lost: ' + response.errorMessage);
            }
            
            appState.mqttConnected = false;
            updateUI();
            
            // Stop tracking if active
            if (appState.trackingActive) {
                stopTracking();
            }
        }

        // MQTT message received callback
        function onMessageArrived(message) {
            try {
                const payload = JSON.parse(message.payloadString);
                addLogEntry(`üì® Received from ${message.destinationName}: ${payload.driver_id} at ${payload.lat}, ${payload.lng}`);
                
                // You could update other bus locations on the map here
                // For example, if you want to show multiple buses
                
            } catch (error) {
                console.error('Error parsing MQTT message:', error);
                addLogEntry(`üì® Received message: ${message.payloadString}`);
            }
        }

        // Disconnect from MQTT
        function disconnectMQTT() {
            if (appState.mqttClient) {
                appState.mqttClient.disconnect();
                appState.mqttClient = null;
            }
            
            appState.mqttConnected = false;
            
            // Stop tracking if active
            if (appState.trackingActive) {
                stopTracking();
            }
            
            updateUI();
            addLogEntry('üîå Disconnected from EMQX broker');
        }

        // Start GPS tracking
        function startTracking() {
            if (!appState.mqttConnected) {
                alert('Please connect to MQTT first');
                return;
            }
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }
            
            // Request location permission and start tracking
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Success - start watching position
                    appState.locationWatcher = navigator.geolocation.watchPosition(
                        onLocationUpdate,
                        onLocationError,
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                    
                    appState.trackingActive = true;
                    updateUI();
                    addLogEntry('üìç Started GPS tracking');
                    
                    // Publish initial location
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    onLocationUpdate(position);
                },
                (error) => {
                    alert('Error getting location: ' + error.message);
                    addLogEntry('‚ùå GPS error: ' + error.message);
                }
            );
        }

        // Location update handler
        function onLocationUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            appState.currentLocation = { lat, lng };
            
            // Update map marker
            if (appState.busMarker) {
                appState.busMarker.setLatLng([lat, lng]);
                appState.busMarker.bindPopup(`Bus Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();
                
                // Center map on current location (only first time)
                if (!appState.mapCentered) {
                    appState.map.setView([lat, lng], 15);
                    appState.mapCentered = true;
                }
            }
            
            // Publish location via MQTT
            if (appState.mqttConnected) {
                publishLocation(lat, lng);
            }
        }

        // Location error handler
        function onLocationError(error) {
            console.error('Geolocation error:', error);
            addLogEntry('‚ùå GPS error: ' + error.message);
        }

        // Publish location to MQTT
        function publishLocation(lat, lng) {
            if (!appState.mqttConnected || !appState.mqttClient) {
                return;
            }
            
            const publishTopic = inputs.publishTopic.value;
            if (!publishTopic) {
                addLogEntry('‚ùå Error: No publish topic specified');
                return;
            }
            
            const message = {
                driver_id: inputs.driverId.value || 'unknown',
                bus_number: inputs.busNumber.value || 'unknown',
                route_name: inputs.routeName.value || 'unknown',
                driver_name: inputs.driverName.value || 'unknown',
                lat: lat,
                lng: lng,
                timestamp: new Date().toISOString(),
                speed: 0, // You could calculate this from previous positions
                heading: 0 // You could calculate this from previous positions
            };
            
            const mqttMessage = new Paho.MQTT.Message(JSON.stringify(message));
            mqttMessage.destinationName = publishTopic;
            
            appState.mqttClient.send(mqttMessage);
            
            addLogEntry(`üì§ Published location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
        }

        // Stop GPS tracking
        function stopTracking() {
            if (appState.locationWatcher) {
                navigator.geolocation.clearWatch(appState.locationWatcher);
                appState.locationWatcher = null;
            }
            
            appState.trackingActive = false;
            updateUI();
            addLogEntry('üõë Stopped GPS tracking');
        }

        // Add entry to tracking log
        function addLogEntry(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message };
            
            appState.logEntries.unshift(entry);
            
            // Keep only last 10 entries
            if (appState.logEntries.length > 10) {
                appState.logEntries.pop();
            }
            
            // Update log display
            updateLogDisplay();
        }

        // Update log display
        function updateLogDisplay() {
            elements.logEntries.innerHTML = '';
            
            appState.logEntries.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-time">[${entry.timestamp}]</span> ${entry.message}
                `;
                elements.logEntries.appendChild(logEntry);
            });
        }

        // Toggle log panel visibility
        function toggleLogPanel() {
            elements.logPanel.classList.toggle('expanded');
            const icon = elements.logToggle.querySelector('i');
            if (elements.logPanel.classList.contains('expanded')) {
                icon.className = 'fas fa-chevron-up';
            } else {
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Show settings modal
        function showSettingsModal() {
            elements.settingsModal.style.display = 'flex';
        }

        // Hide settings modal
        function hideSettingsModal() {
            elements.settingsModal.style.display = 'none';
        }

        // Show help information
        function showHelp() {
            alert('üöå School Bus Tracker Help:\n\nüì° CONNECTION:\n- EMQX broker is pre-configured\n- Click "Connect to EMQX" to establish connection\n- No username/password required for public broker\n\nüìç TRACKING:\n- Click "Start Tracking" to begin GPS tracking\n- Location updates every 3 seconds (configurable)\n- Data is published to MQTT topic\n\nüìä TOPICS:\n- Publish: schoolbus/driver/location\n- Subscribe: schoolbus/dispatch/commands\n\n‚öôÔ∏è SETTINGS:\n- Adjust GPS update interval\n- Change map style\n- Clear stored data if needed');
        }

        // Save app settings
        function saveAppSettings() {
            appState.settings.gpsInterval = parseInt(elements.gpsInterval.value);
            appState.settings.mapStyle = elements.mapStyle.value;
            
            saveSettings();
            hideSettingsModal();
            addLogEntry('‚öôÔ∏è Settings saved');
            
            // Reinitialize map with new style if needed
            if (appState.map) {
                appState.map.remove();
                initMap();
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all saved data?\n\nThis will reset all settings to default but keep the EMQX broker configuration.')) {
                localStorage.clear();
                appState.logEntries = [];
                updateLogDisplay();
                
                // Reset to default EMQX config but keep user modifications
                setDefaultConfig();
                
                addLogEntry('üóëÔ∏è All data cleared, EMQX configuration restored');
                hideSettingsModal();
                updateBusInfo();
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
